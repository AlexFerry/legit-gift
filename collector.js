import axios from 'axios';
import * as cheerio from 'cheerio';
import fs from 'fs-extra';
import dotenv from 'dotenv';
import path from 'path';
import { fileURLToPath } from 'url';

// Carregar vari√°veis de ambiente
dotenv.config();

// Configura√ß√µes
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);
const CODES_FILE = path.join(__dirname, 'codes.json');
const DISCORD_WEBHOOK = process.env.DISCORD_WEBHOOK;

// Lista de fontes para coleta de c√≥digos
const SOURCES = [
  'https://lootbar.gg/blog/en/legend-of-mushroom-codes.html',
  'https://www.pockettactics.com/legend-of-mushroom/codes',
  'https://www.pocketgamer.com/legend-of-mushroom/codes/',
  'https://theriagames.com/guide/legend-of-mushroom-codes/',
  'https://www.facebook.com/legendofmushroom/'
];

// Regex para extrair c√≥digos alfanum√©ricos (3-20 caracteres)
const CODE_REGEX = /\b[A-Z0-9]{3,20}\b/g;

/**
 * Faz requisi√ß√£o HTTP para uma URL com timeout e user-agent
 */
async function fetchPage(url) {
  try {
    const response = await axios.get(url, {
      timeout: 10000,
      headers: {
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
      }
    });
    return response.data;
  } catch (error) {
    console.error(`‚ùå Erro ao buscar ${url}:`, error.message);
    return null;
  }
}

/**
 * Extrai texto limpo de HTML usando cheerio
 */
function extractText(html) {
  const $ = cheerio.load(html);
  // Remove scripts e styles
  $('script').remove();
  $('style').remove();
  // Extrai texto
  return $.text();
}

/**
 * Extrai c√≥digos do texto usando regex
 */
function extractCodes(text) {
  const codes = new Set();
  const matches = text.match(CODE_REGEX);
  
  if (matches) {
    matches.forEach(code => {
      // Filtros para evitar falsos positivos
      if (!isCommonWord(code)) {
        codes.add(code);
      }
    });
  }
  
  return Array.from(codes);
}

/**
 * Verifica se a string √© uma palavra comum (para evitar falsos positivos)
 */
function isCommonWord(str) {
  const commonWords = [
    'LEGEND', 'MUSHROOM', 'GAME', 'PLAY', 'CODE', 'GIFT', 'REWARD',
    'CLICK', 'HERE', 'LINK', 'FOLLOW', 'SUBSCRIBE', 'LIKE', 'SHARE',
    'DOWNLOAD', 'INSTALL', 'UPDATE', 'VERSION', 'LEVEL', 'QUEST',
    'ITEM', 'WEAPON', 'ARMOR', 'SKILL', 'SPELL', 'MAGIC', 'ATTACK',
    'DEFENSE', 'HEALTH', 'MANA', 'EXPERIENCE', 'GOLD', 'SILVER',
    'BRONZE', 'DIAMOND', 'RUBY', 'EMERALD', 'SAPPHIRE', 'CRYSTAL',
    'STONE', 'WOOD', 'METAL', 'FIRE', 'WATER', 'EARTH', 'AIR',
    'WIND', 'THUNDER', 'LIGHT', 'DARK', 'HOLY', 'EVIL', 'GOOD',
    'BAD', 'STRONG', 'WEAK', 'FAST', 'SLOW', 'BIG', 'SMALL'
  ];
  return commonWords.includes(str.toUpperCase());
}

/**
 * Carrega c√≥digos existentes do arquivo JSON
 */
async function loadCodes() {
  try {
    if (await fs.pathExists(CODES_FILE)) {
      const data = await fs.readFile(CODES_FILE, 'utf8');
      return JSON.parse(data);
    }
  } catch (error) {
    console.error('‚ùå Erro ao carregar codes.json:', error.message);
  }
  return {};
}

/**
 * Salva c√≥digos no arquivo JSON
 */
async function saveCodes(codes) {
  try {
    await fs.writeFile(CODES_FILE, JSON.stringify(codes, null, 2));
    console.log('‚úÖ codes.json atualizado');
  } catch (error) {
    console.error('‚ùå Erro ao salvar codes.json:', error.message);
  }
}

/**
 * Coleta c√≥digos de todas as fontes
 */
async function collectCodes() {
  console.log('üîÑ Iniciando coleta de c√≥digos...\n');
  
  const allCodes = {};
  
  for (const source of SOURCES) {
    console.log(`üìç Processando: ${source}`);
    
    const html = await fetchPage(source);
    if (!html) continue;
    
    const text = extractText(html);
    const codes = extractCodes(text);
    
    console.log(`   Encontrados ${codes.length} c√≥digos potenciais`);
    
    codes.forEach(code => {
      allCodes[code] = source;
    });
  }
  
  return allCodes;
}

/**
 * Compara c√≥digos encontrados com os j√° armazenados
 */
function findNewCodes(foundCodes, existingCodes) {
  const newCodes = [];
  
  Object.keys(foundCodes).forEach(code => {
    if (!existingCodes[code]) {
      newCodes.push(code);
    } else {
      // Atualizar last_seen se o c√≥digo j√° existe
      existingCodes[code].last_seen = new Date().toISOString();
      
      // Adicionar fonte se n√£o estiver na lista
      const source = foundCodes[code];
      if (!existingCodes[code].sources.includes(source)) {
        existingCodes[code].sources.push(source);
      }
    }
  });
  
  return newCodes;
}

/**
 * Adiciona novos c√≥digos ao objeto de c√≥digos
 */
function addNewCodes(newCodes, foundCodes, existingCodes) {
  const now = new Date().toISOString();
  
  newCodes.forEach(code => {
    existingCodes[code] = {
      code: code,
      sources: [foundCodes[code]],
      first_seen: now,
      last_seen: now
    };
  });
  
  return existingCodes;
}

/**
 * Envia notifica√ß√£o para Discord via webhook
 */
async function notifyDiscord(newCodes) {
  if (!DISCORD_WEBHOOK) {
    console.log('‚ö†Ô∏è  DISCORD_WEBHOOK n√£o configurado, pulando notifica√ß√£o');
    return;
  }
  
  if (newCodes.length === 0) {
    console.log('‚ÑπÔ∏è  Nenhum c√≥digo novo para notificar');
    return;
  }
  
  try {
    const message = `üéÅ **Novos C√≥digos Encontrados!**\n\n${newCodes.join(', ')}`;
    
    await axios.post(DISCORD_WEBHOOK, {
      content: message
    });
    
    console.log(`‚úÖ Notifica√ß√£o enviada para Discord (${newCodes.length} c√≥digo(s) novo(s))`);
  } catch (error) {
    console.error('‚ùå Erro ao enviar notifica√ß√£o para Discord:', error.message);
  }
}

/**
 * Fun√ß√£o principal
 */
async function main() {
  try {
    // Carregar c√≥digos existentes
    const existingCodes = await loadCodes();
    console.log(`üì¶ C√≥digos j√° armazenados: ${Object.keys(existingCodes).length}\n`);
    
    // Coletar novos c√≥digos
    const foundCodes = await collectCodes();
    console.log(`\nüîç Total de c√≥digos encontrados nesta execu√ß√£o: ${Object.keys(foundCodes).length}\n`);
    
    // Encontrar novos c√≥digos
    const newCodes = findNewCodes(foundCodes, existingCodes);
    console.log(`‚ú® C√≥digos novos: ${newCodes.length}`);
    
    if (newCodes.length > 0) {
      console.log(`   Novos: ${newCodes.join(', ')}\n`);
      
      // Adicionar novos c√≥digos
      const updatedCodes = addNewCodes(newCodes, foundCodes, existingCodes);
      
      // Salvar
      await saveCodes(updatedCodes);
      
      // Notificar Discord
      await notifyDiscord(newCodes);
    } else {
      console.log('   Nenhum c√≥digo novo encontrado\n');
    }
    
    console.log('‚úÖ Coleta conclu√≠da com sucesso!');
  } catch (error) {
    console.error('‚ùå Erro durante a execu√ß√£o:', error.message);
    process.exit(1);
  }
}

// Executar
main();

